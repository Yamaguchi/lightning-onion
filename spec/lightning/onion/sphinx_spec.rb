# frozen_string_literal: true

require 'spec_helper'

describe Lightning::Onion::Sphinx do
  let(:private_keys) do
    [
      '4141414141414141414141414141414141414141414141414141414141414141',
      '4242424242424242424242424242424242424242424242424242424242424242',
      '4343434343434343434343434343434343434343434343434343434343434343',
      '4444444444444444444444444444444444444444444444444444444444444444',
      '4545454545454545454545454545454545454545454545454545454545454545'
    ]
  end
  let(:public_keys) do
    [
      '02eec7245d6b7d2ccb30380bfbe2a3648cd7a942653f5aa340edcea1f283686619',
      '0324653eac434488002cc06bbfb7f10fe18991e35f9fe4302dbea6d2353dc0ab1c',
      '027f31ebc5462c1fdce1b737ecff52d37d75dea43ce11c74d25aa297165faa2007',
      '032c0b7cf95324a07d05398b240174dc0c2be444d96b159aa6c7f7b1e668680991',
      '02edabbd16b41c8371b92ef2f04c1185b4f03b6dcd52ba9b78d9d7c89c8f221145'
    ]
  end
  let(:session_key) { '4141414141414141414141414141414141414141414141414141414141414141' }
  let(:payloads) do
    [
      '000000000000000000000000000000000000000000000000000000000000000000',
      '000101010101010101000000010000000100000000000000000000000000000000',
      '000202020202020202000000020000000200000000000000000000000000000000',
      '000303030303030303000000030000000300000000000000000000000000000000',
      '000404040404040404000000040000000400000000000000000000000000000000'
    ]
  end
  let(:associated_data) { '4242424242424242424242424242424242424242424242424242424242424242' }
  describe '.compute_ephemereal_public_keys_and_shared_secrets' do
    subject { described_class.compute_ephemereal_public_keys_and_shared_secrets(session_key, public_keys) }

    # hop_shared_secret[0] = 0x53eb63ea8a3fec3b3cd433b85cd62a4b145e1dda09391b348c4e1cd36a03ea66
    # hop_blinding_factor[0] = 0x2ec2e5da605776054187180343287683aa6a51b4b1c04d6dd49c45d8cffb3c36
    # hop_ephemeral_pubkey[0] = 0x02eec7245d6b7d2ccb30380bfbe2a3648cd7a942653f5aa340edcea1f283686619
    #
    # hop_shared_secret[1] = 0xa6519e98832a0b179f62123b3567c106db99ee37bef036e783263602f3488fae
    # hop_blinding_factor[1] = 0xbf66c28bc22e598cfd574a1931a2bafbca09163df2261e6d0056b2610dab938f
    # hop_ephemeral_pubkey[1] = 0x028f9438bfbf7feac2e108d677e3a82da596be706cc1cf342b75c7b7e22bf4e6e2
    #
    # hop_shared_secret[2] = 0x3a6b412548762f0dbccce5c7ae7bb8147d1caf9b5471c34120b30bc9c04891cc
    # hop_blinding_factor[2] = 0xa1f2dadd184eb1627049673f18c6325814384facdee5bfd935d9cb031a1698a5
    # hop_ephemeral_pubkey[2] = 0x03bfd8225241ea71cd0843db7709f4c222f62ff2d4516fd38b39914ab6b83e0da0
    #
    # hop_shared_secret[3] = 0x21e13c2d7cfe7e18836df50872466117a295783ab8aab0e7ecc8c725503ad02d
    # hop_blinding_factor[3] = 0x7cfe0b699f35525029ae0fa437c69d0f20f7ed4e3916133f9cacbb13c82ff262
    # hop_ephemeral_pubkey[3] = 0x031dde6926381289671300239ea8e57ffaf9bebd05b9a5b95beaf07af05cd43595
    #
    # hop_shared_secret[4] = 0xb5756b9b542727dbafc6765a49488b023a725d631af688fc031217e90770c328
    # hop_blinding_factor[4] = 0xc96e00dddaf57e7edcd4fb5954be5b65b09f17cb6d20651b4e90315be5779205
    # hop_ephemeral_pubkey[4] = 0x03a214ebd875aab6ddfd77f22c5e7311d7f77f17a169e599f157bbcdae8bf071f4
    it { expect(subject[0][0]).to eq '02eec7245d6b7d2ccb30380bfbe2a3648cd7a942653f5aa340edcea1f283686619' }
    it { expect(subject[1][0]).to eq '53eb63ea8a3fec3b3cd433b85cd62a4b145e1dda09391b348c4e1cd36a03ea66' }
    it { expect(subject[0][1]).to eq '028f9438bfbf7feac2e108d677e3a82da596be706cc1cf342b75c7b7e22bf4e6e2' }
    it { expect(subject[1][1]).to eq 'a6519e98832a0b179f62123b3567c106db99ee37bef036e783263602f3488fae' }
    it { expect(subject[0][2]).to eq '03bfd8225241ea71cd0843db7709f4c222f62ff2d4516fd38b39914ab6b83e0da0' }
    it { expect(subject[1][2]).to eq '3a6b412548762f0dbccce5c7ae7bb8147d1caf9b5471c34120b30bc9c04891cc' }
    it { expect(subject[0][3]).to eq '031dde6926381289671300239ea8e57ffaf9bebd05b9a5b95beaf07af05cd43595' }
    it { expect(subject[1][3]).to eq '21e13c2d7cfe7e18836df50872466117a295783ab8aab0e7ecc8c725503ad02d' }
    it { expect(subject[0][4]).to eq '03a214ebd875aab6ddfd77f22c5e7311d7f77f17a169e599f157bbcdae8bf071f4' }
    it { expect(subject[1][4]).to eq 'b5756b9b542727dbafc6765a49488b023a725d631af688fc031217e90770c328' }
  end

  describe '.generate_cipher_stream' do
    let(:expected) do
      'e5f14350c2a76fc232b5e46d421e9615471ab9e0bc887beff8c95fdb878f7b3a' \
      '7141453e5f8d22b6351810ae541ce499a09b4a9d9f80d1845c8960c85fc6d1a8' \
      '7bd24b2ce49922898e9353fa268086c00ae8b7f718405b72ad380cdbb38c85e0' \
      '2a00427eb4bdbda8fcd42b44708a9efde49cf753b75ebb389bf84d0bfbf58590' \
      'e510e034572a01e409c30939e2e4a090ecc89c371820af54e06e4ad5495d4e58' \
      '718385cca5414552e078fedf284fdc2cc5c070cba21a6a8d4b77525ddbc9a9fc' \
      'a9b2f29aac5783ee8badd709f81c73ff60556cf2ee623af073b5a84799acc1ca' \
      '46b764f74b97068c7826cc0579794a540d7a55e49eac26a6930340132e946a98' \
      '3240b0cd1b732e305c1042f590c4b26f140fc1cab3ee6f620958e0979f85eddf' \
      '586c410ce42e93a4d7c803ead45fc47cf4396d284632314d789e73cf3f534126' \
      'c63fe244069d9e8a7c4f98e7e530fc588e648ef4e641364981b5377542d5e7a4' \
      'aaab6d35f6df7d3a9d7ca715213599ee02c4dbea4dc78860febe1d29259c64b5' \
      '9b3333ffdaebbaff4e7b31c27a3791f6bf848a58df7c69bb2b1852d2ad357b99' \
      '19ffdae570b27dc709fba087273d3a4de9e6a6be66db647fb6a8d1a503b3f481' \
      'befb96745abf5cc4a6bba0f780d5c7759b9e303a2a6b17eb05b6e660f4c47495' \
      '9db183e1cae060e1639227ee0bca03978a238dc4352ed764da7d4f3ed5337f6d' \
      '0376dff72615beeeeaaeef79ab93e4bcbf18cd8424eb2b6ad7f33d2b4ffd5ea0' \
      '8372e6ed1d984152df17e04c6f73540988d7dd979e020424a163c271151a2559' \
      '66be7edef42167b8facca633649739bab97572b485658cde409e5d4a0f653f1a' \
      '5911141634e3d2b6079b19347df66f9820755fd517092dae62fb278b0bafcc7a' \
      'd682f7921b3a455e0c6369988779e26f0458b31bffd7e4e5bfb31944e80f100b' \
      '2553c3b616e75be18328dc430f6618d55cd7d0962bb916d26ed4b117c46fa29e' \
      '0a112c02c36020b34a96762db628fa3490828ec2079962ad816ef20ea0bca78f' \
      'b2b7f7aedd4c47e375e64294d151ff03083730336dea64934003a27730cc1c7d' \
      'ec5049ddba8188123dd191aa71390d43a49fb792a3da7082efa6cced73f00ecc' \
      'ea18145fbc84925349f7b552314ab8ed4c491e392aed3b1f03eb79474c294b42' \
      'e2eba1528da26450aa592cba7ea22e965c54dff0fd6fdfd6b52b9a0f5f762e27' \
      'fb0e6c3cd326a1ca1c5973de9be881439f702830affeb0c034c18ac8d5c2f135' \
      'c964bf69de50d6e99bde88e90321ba843d9753c8f83666105d25fafb1a11ea22' \
      'd62ef6f1fc34ca4e60c35d69773a104d9a44728c08c20b6314327301a2c400a7' \
      '1e1424c12628cf9f4a67990ade8a2203b0edb96c6082d4673b7309cd52c4b32b' \
      '02951db2f66c6c72bd6c7eac2b50b83830c75cdfc3d6e9c2b592c45ed5fa5f6e' \
      'c0da85710b7e1562aea363e28665835791dc574d9a70b2e5e2b9973ab590d45b' \
      '94d244fc4256926c5a55b01cd0aca21fe5f9c907691fb026d0c56788b03ca3f0' \
      '8db0abb9f901098dde2ec4003568bc3ca27475ff86a7cb0aabd9e5136c5de064' \
      'd16774584b252024109bb02004dba1fabf9e8277de097a0ab0dc8f6e26fcd4a2' \
      '8fb9d27cd4a2f6b13e276ed259a39e1c7e60f3c32c5cc4c4f96bd981edcb5e2c' \
      '76a517cdc285aa2ca571d1e3d463ecd7614ae227df17af7445305bd7c661cf7d' \
      'ba658b0adcf36b0084b74a5fa408e272f703770ac5351334709112c5d4e4fe98' \
      '7e0c27b670412696f52b33245c229775da550729938268ee4e7a282e4a60b25d' \
      'bb28ea8877a5069f819e5d1d31d9140bbc627ff3989115ade30d309374fea843' \
      '5815418038534d12e4ffe88b91406a71d89d5a083e3b8224d86b2be11be32169' \
      'afb04b9ea997854be9085472c342ef5fca19bf5479'
    end
    let(:key) { 'ce496ec94def95aadd4bec15cdb41a740c9f2b62347c4917325fcc6fb0453986'.htb }
    subject { described_class.generate_cipher_stream(key, 1365).bth }
    it { is_expected.to eq expected }
  end

  describe '.generate_filler' do
    # filler =
    # 0xc6b008cf6414ed6e4c42c291eb505e9f22f5fe7d0ecdd15a833f4d016ac974
    # d33adc6ea3293e20859e87ebfb937ba406abd025d14af692b12e9c9c2adbe307
    # a679779259676211c071e614fdb386d1ff02db223a5b2fae03df68d321c7b29f
    # 7c7240edd3fa1b7cb6903f89dc01abf41b2eb0b49b6b8d73bb0774b58204c0d0
    # e96d3cce45ad75406be0bc009e327b3e712a4bd178609c00b41da2daf8a4b0e1
    # 319f07a492ab4efb056f0f599f75e6dc7e0d10ce1cf59088ab6e873de3773438
    # 80f7a24f0e36731a0b72092f8d5bc8cd346762e93b2bf203d00264e4bc136fc1
    # 42de8f7b69154deb05854ea88e2d7506222c95ba1aab065c8a851391377d3406
    # a35a9af3ac
    let(:shared_secrets) do
      described_class.compute_ephemereal_public_keys_and_shared_secrets(session_key, public_keys)[1]
    end
    let(:key_type) { 'rho' }
    let(:expected) do
      'c6b008cf6414ed6e4c42c291eb505e9f22f5fe7d0ecdd15a833f4d016ac974d3' \
      '3adc6ea3293e20859e87ebfb937ba406abd025d14af692b12e9c9c2adbe307a6' \
      '79779259676211c071e614fdb386d1ff02db223a5b2fae03df68d321c7b29f7c' \
      '7240edd3fa1b7cb6903f89dc01abf41b2eb0b49b6b8d73bb0774b58204c0d0e9' \
      '6d3cce45ad75406be0bc009e327b3e712a4bd178609c00b41da2daf8a4b0e131' \
      '9f07a492ab4efb056f0f599f75e6dc7e0d10ce1cf59088ab6e873de377343880' \
      'f7a24f0e36731a0b72092f8d5bc8cd346762e93b2bf203d00264e4bc136fc142' \
      'de8f7b69154deb05854ea88e2d7506222c95ba1aab065c8a851391377d3406a3' \
      '5a9af3ac'
    end
    let(:payload_length) { 33 }
    let(:mac_length) { 32 }
    subject { described_class.generate_filler(key_type, shared_secrets[0...-1], payload_length + mac_length, 20) }
    it { is_expected.to eq expected }
  end

  describe '.make_packet' do
    let(:expected) do
      '0002eec7245d6b7d2ccb30380bfbe2a3648cd7a942653f5aa340edcea1f28368' \
      '6619e5f14350c2a76fc232b5e46d421e9615471ab9e0bc887beff8c95fdb878f' \
      '7b3a716a996c7845c93d90e4ecbb9bde4ece2f69425c99e4bc820e44485455f1' \
      '35edc0d10f7d61ab590531cf08000179a333a347f8b4072f216400406bdf3bf0' \
      '38659793d4a1fd7b246979e3150a0a4cb052c9ec69acf0f48c3d39cd55675fe7' \
      '17cb7d80ce721caad69320c3a469a202f1e468c67eaf7a7cd8226d0fd32f7b48' \
      '084dca885d56047694762b67021713ca673929c163ec36e04e40ca8e1c6d1756' \
      '9419d3039d9a1ec866abe044a9ad635778b961fc0776dc832b3a451bd5d35072' \
      'd2269cf9b040f6b7a7dad84fb114ed413b1426cb96ceaf83825665ed5a1d002c' \
      '1687f92465b49ed4c7f0218ff8c6c7dd7221d589c65b3b9aaa71a41484b12284' \
      '6c7c7b57e02e679ea8469b70e14fe4f70fee4d87b910cf144be6fe48eef24da4' \
      '75c0b0bcc6565ae82cd3f4e3b24c76eaa5616c6111343306ab35c1fe5ca4a77c' \
      '0e314ed7dba39d6f1e0de791719c241a939cc493bea2bae1c1e932679ea94d29' \
      '084278513c77b899cc98059d06a27d171b0dbdf6bee13ddc4fc17a0c4d2827d4' \
      '88436b57baa167544138ca2e64a11b43ac8a06cd0c2fba2d4d900ed2d9205305' \
      'e2d7383cc98dacb078133de5f6fb6bed2ef26ba92cea28aafc3b9948dd9ae555' \
      '9e8bd6920b8cea462aa445ca6a95e0e7ba52961b181c79e73bd581821df2b101' \
      '73727a810c92b83b5ba4a0403eb710d2ca10689a35bec6c3a708e9e92f7d78ff' \
      '3c5d9989574b00c6736f84c199256e76e19e78f0c98a9d580b4a658c84fc8f20' \
      '96c2fbea8f5f8c59d0fdacb3be2802ef802abbecb3aba4acaac69a0e965abd89' \
      '81e9896b1f6ef9d60f7a164b371af869fd0e48073742825e9434fc54da837e12' \
      '0266d53302954843538ea7c6c3dbfb4ff3b2fdbe244437f2a153ccf7bdb4c92a' \
      'a08102d4f3cff2ae5ef86fab4653595e6a5837fa2f3e29f27a9cde5966843fb8' \
      '47a4a61f1e76c281fe8bb2b0a181d096100db5a1a5ce7a910238251a43ca5567' \
      '12eaadea167fb4d7d75825e440f3ecd782036d7574df8bceacb397abefc5f525' \
      '4d2722215c53ff54af8299aaaad642c6d72a14d27882d9bbd539e1cc7a527526' \
      'ba89b8c037ad09120e98ab042d3e8652b31ae0e478516bfaf88efca9f3676ffe' \
      '99d2819dcaeb7610a626695f53117665d267d3f7abebd6bbd6733f645c72c389' \
      'f03855bdf1e4b8075b516569b118233a0f0971d24b83113c0b096f5216a207ca' \
      '99a7cddc81c130923fe3d91e7508c9ac5f2e914ff5dccab9e558566fa14efb34' \
      'ac98d878580814b94b73acbfde9072f30b881f7f0fff42d4045d1ace6322d86a' \
      '97d164aa84d93a60498065cc7c20e636f5862dc81531a88c60305a2e59a985be' \
      '327a6902e4bed986dbf4a0b50c217af0ea7fdf9ab37f9ea1a1aaa72f54cf4015' \
      '4ea9b269f1a7c09f9f43245109431a175d50e2db0132337baa0ef97eed0fcf20' \
      '489da36b79a1172faccc2f7ded7c60e00694282d93359c4682135642bc81f433' \
      '574aa8ef0c97b4ade7ca372c5ffc23c7eddd839bab4e0f14d6df15c9dbeab176' \
      'bec8b5701cf054eb3072f6dadc98f88819042bf10c407516ee58bce33fbe3b3d' \
      '86a54255e577db4598e30a135361528c101683a5fcde7e8ba53f3456254be8f4' \
      '5fe3a56120ae96ea3773631fcb3873aa3abd91bcff00bd38bd43697a2e789e00' \
      'da6077482e7b1b1a677b5afae4c54e6cbdf7377b694eb7d7a5b913476a5be923' \
      '322d3de06060fd5e819635232a2cf4f0731da13b8546d1d6d4f8d75b9fce6c23' \
      '41a71b0ea6f780df54bfdb0dd5cd9855179f602f9172307c7268724c3618e681' \
      '7abd793adc214a0dc0bc616816632f27ea336fb56dfd'
    end
    subject { described_class.make_packet(session_key, public_keys, payloads, associated_data) }
    it { expect(subject[0].to_payload.bth).to eq expected }
  end

  describe '.parse' do
    let(:packet) { Lightning::Onion::Sphinx.make_packet(session_key, public_keys, payloads, associated_data) }
    it 'parse onion packet correctly' do
      payload0, next_packet0, = described_class.parse(private_keys[0], packet[0].to_payload)
      payload1, next_packet1, = described_class.parse(private_keys[1], next_packet0.to_payload)
      payload2, next_packet2, = described_class.parse(private_keys[2], next_packet1.to_payload)
      payload3, next_packet3, = described_class.parse(private_keys[3], next_packet2.to_payload)
      payload4, next_packet4, = described_class.parse(private_keys[4], next_packet3.to_payload)
      expect(payload0.bth).to eq payloads[0]
      expect(payload1.bth).to eq payloads[1]
      expect(payload2.bth).to eq payloads[2]
      expect(payload3.bth).to eq payloads[3]
      expect(payload4.bth).to eq payloads[4]

      packets = [next_packet0, next_packet1, next_packet2, next_packet3, next_packet4]
      expect(packets[0].hmac.bth).to eq '2bdc5227c8eb8ba5fcfc15cfc2aa578ff208c106646d0652cd289c0a37e445bb'
      expect(packets[1].hmac.bth).to eq '28430b210c0af631ef80dc8594c08557ce4626bdd3593314624a588cc083a1d9'
      expect(packets[2].hmac.bth).to eq '4e888d0cc6a90e7f857af18ac858834ac251d0d1c196d198df48a0c5bf816803'
      expect(packets[3].hmac.bth).to eq '42c10947e06bda75b35ac2a9e38005479a6feac51468712e751c71a1dcf3e31b'
      expect(packets[4].hmac.bth).to eq '0000000000000000000000000000000000000000000000000000000000000000'
    end
  end

  # # node 4 is returning an error
  # failure_message = 2002
  # # creating error message
  # shared_secret = b5756b9b542727dbafc6765a49488b023a725d631af688fc031217e90770c328
  # payload =
  # 0002200200fe0000000000000000000000000000000000000000000000000000
  # 0000000000000000000000000000000000000000000000000000000000000000
  # 0000000000000000000000000000000000000000000000000000000000000000
  # 0000000000000000000000000000000000000000000000000000000000000000
  # 0000000000000000000000000000000000000000000000000000000000000000
  # 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
  # um_key = 4da7f2923edce6c2d85987d1d9fa6d88023e6c3a9c3d20f07d3b10b61a78d646
  # raw_error_packet = 4c2fc8bc08510334b6833ad9c3e79cd1b52ae59dfe5c2a4b23ead50f09f7ee0b0002200200fe0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
  # # forwarding error packet
  # shared_secret = b5756b9b542727dbafc6765a49488b023a725d631af688fc031217e90770c328
  #  ammag_key = 2f36bb8822e1f0d04c27b7d8bb7d7dd586e032a3218b8d414afbba6f169a4d68
  # stream = e9c975b07c9a374ba64fd9be3aae955e917d34d1fa33f2e90f53bbf4394713c6a8c9b16ab5f12fd45edd73c1b0c8b33002df376801ff58aaa94000bf8a86f92620f343baef38a580102395ae3abf9128d1047a0736ff9b83d456740ebbb4aeb3aa9737f18fb4afb4aa074fb26c4d702f42968888550a3bded8c05247e045b866baef0499f079fdaeef6538f31d44deafffdfd3afa2fb4ca9082b8f1c465371a9894dd8c243fb4847e004f5256b3e90e2edde4c9fb3082ddfe4d1e734cacd96ef0706bf63c9984e22dc98851bcccd1c3494351feb458c9c6af41c0044bea3c47552b1d992ae542b17a2d0bba1a096c78d169034ecb55b6e3a7263c26017f033031228833c1daefc0dedb8cf7c3e37c9c37ebfe42f3225c326e8bcfd338804c145b16e34e4
  # error packet for node 4: a5e6bd0c74cb347f10cce367f949098f2457d14c046fd8a22cb96efb30b0fdcda8cb9168b50f2fd45edd73c1b0c8b33002df376801ff58aaa94000bf8a86f92620f343baef38a580102395ae3abf9128d1047a0736ff9b83d456740ebbb4aeb3aa9737f18fb4afb4aa074fb26c4d702f42968888550a3bded8c05247e045b866baef0499f079fdaeef6538f31d44deafffdfd3afa2fb4ca9082b8f1c465371a9894dd8c243fb4847e004f5256b3e90e2edde4c9fb3082ddfe4d1e734cacd96ef0706bf63c9984e22dc98851bcccd1c3494351feb458c9c6af41c0044bea3c47552b1d992ae542b17a2d0bba1a096c78d169034ecb55b6e3a7263c26017f033031228833c1daefc0dedb8cf7c3e37c9c37ebfe42f3225c326e8bcfd338804c145b16e34e4
  # # forwarding error packet
  # shared_secret = 21e13c2d7cfe7e18836df50872466117a295783ab8aab0e7ecc8c725503ad02d
  # ammag_key = cd9ac0e09064f039fa43a31dea05f5fe5f6443d40a98be4071af4a9d704be5ad
  # stream = 617ca1e4624bc3f04fece3aa5a2b615110f421ec62408d16c48ea6c1b7c33fe7084a2bd9d4652fc5068e5052bf6d0acae2176018a3d8c75f37842712913900263cff92f39f3c18aa1f4b20a93e70fc429af7b2b1967ca81a761d40582daf0eb49cef66e3d6fbca0218d3022d32e994b41c884a27c28685ef1eb14603ea80a204b2f2f474b6ad5e71c6389843e3611ebeafc62390b717ca53b3670a33c517ef28a659c251d648bf4c966a4ef187113ec9848bf110816061ca4f2f68e76ceb88bd6208376460b916fb2ddeb77a65e8f88b2e71a2cbf4ea4958041d71c17d05680c051c3676fb0dc8108e5d78fb1e2c44d79a202e9d14071d536371ad47c39a05159e8d6c41d17a1e858faaaf572623aa23a38ffc73a4114cb1ab1cd7f906c6bd4e21b29694
  # error packet for node 3: c49a1ce81680f78f5f2000cda36268de34a3f0a0662f55b4e837c83a8773c22aa081bab1616a0011585323930fa5b9fae0c85770a2279ff59ec427ad1bbff9001c0cd1497004bd2a0f68b50704cf6d6a4bf3c8b6a0833399a24b3456961ba00736785112594f65b6b2d44d9f5ea4e49b5e1ec2af978cbe31c67114440ac51a62081df0ed46d4a3df295da0b0fe25c0115019f03f15ec86fabb4c852f83449e812f141a9395b3f70b766ebbd4ec2fae2b6955bd8f32684c15abfe8fd3a6261e52650e8807a92158d9f1463261a925e4bfba44bd20b166d532f0017185c3a6ac7957adefe45559e3072c8dc35abeba835a8cb01a71a15c736911126f27d46a36168ca5ef7dccd4e2886212602b181463e0dd30185c96348f9743a02aca8ec27c0b90dca270
  # forwarding error packet
  # shared_secret = 3a6b412548762f0dbccce5c7ae7bb8147d1caf9b5471c34120b30bc9c04891cc
  # ammag_key = 1bf08df8628d452141d56adfd1b25c1530d7921c23cecfc749ac03a9b694b0d3
  # stream = 6149f48b5a7e8f3d6f5d870b7a698e204cf64452aab4484ff1dee671fe63fd4b5f1b78ee2047dfa61e3d576b149bedaf83058f85f06a3172a3223ad6c4732d96b32955da7d2feb4140e58d86fc0f2eb5d9d1878e6f8a7f65ab9212030e8e915573ebbd7f35e1a430890be7e67c3fb4bbf2def662fa625421e7b411c29ebe81ec67b77355596b05cc155755664e59c16e21410aabe53e80404a615f44ebb31b365ca77a6e91241667b26c6cad24fb2324cf64e8b9dd6e2ce65f1f098cfd1ef41ba2d4c7def0ff165a0e7c84e7597c40e3dffe97d417c144545a0e38ee33ebaae12cc0c14650e453d46bfc48c0514f354773435ee89b7b2810606eb73262c77a1d67f3633705178d79a1078c3a01b5fadc9651feb63603d19decd3a00c1f69af2dab259593
  # error packet for node 2: a5d3e8634cfe78b2307d87c6d90be6fe7855b4f2cc9b1dfb19e92e4b79103f61ff9ac25f412ddfb7466e74f81b3e545563cdd8f5524dae873de61d7bdfccd496af2584930d2b566b4f8d3881f8c043df92224f38cf094cfc09d92655989531524593ec6d6caec1863bdfaa79229b5020acc034cd6deeea1021c50586947b9b8e6faa83b81fbfa6133c0af5d6b07c017f7158fa94f0d206baf12dda6b68f785b773b360fd0497e16cc402d779c8d48d0fa6315536ef0660f3f4e1865f5b38ea49c7da4fd959de4e83ff3ab686f059a45c65ba2af4a6a79166aa0f496bf04d06987b6d2ea205bdb0d347718b9aeff5b61dfff344993a275b79717cd815b6ad4c0beb568c4ac9c36ff1c315ec1119a1993c4b61e6eaa0375e0aaf738ac691abd3263bf937e3
  # # forwarding error packet
  # shared_secret = a6519e98832a0b179f62123b3567c106db99ee37bef036e783263602f3488fae
  # ammag_key = 59ee5867c5c151daa31e36ee42530f429c433836286e63744f2020b980302564
  # stream = 0f10c86f05968dd91188b998ee45dcddfbf89fe9a99aa6375c42ed5520a257e048456fe417c15219ce39d921555956ae2ff795177c63c819233f3bcb9b8b28e5ac6e33a3f9b87ca62dff43f4cc4a2755830a3b7e98c326b278e2bd31f4a9973ee99121c62873f5bfb2d159d3d48c5851e3b341f9f6634f51939188c3b9ff45feeb11160bb39ce3332168b8e744a92107db575ace7866e4b8f390f1edc4acd726ed106555900a0832575c3a7ad11bb1fe388ff32b99bcf2a0d0767a83cf293a220a983ad014d404bfa20022d8b369fe06f7ecc9c74751dcda0ff39d8bca74bf9956745ba4e5d299e0da8f68a9f660040beac03e795a046640cf8271307a8b64780b0588422f5a60ed7e36d60417562938b400802dac5f87f267204b6d5bcfd8a05b221ec2
  # error packet for node 1: aac3200c4968f56b21f53e5e374e3a2383ad2b1b6501bbcc45abc31e59b26881b7dfadbb56ec8dae8857add94e6702fb4c3a4de22e2e669e1ed926b04447fc73034bb730f4932acd62727b75348a648a1128744657ca6a4e713b9b646c3ca66cac02cdab44dd3439890ef3aaf61708714f7375349b8da541b2548d452d84de7084bb95b3ac2345201d624d31f4d52078aa0fa05a88b4e20202bd2b86ac5b52919ea305a8949de95e935eed0319cf3cf19ebea61d76ba92532497fcdc9411d06bcd4275094d0a4a3c5d3a945e43305a5a9256e333e1f64dbca5fcd4e03a39b9012d197506e06f29339dfee3331995b21615337ae060233d39befea925cc262873e0530408e6990f1cbd233a150ef7b004ff6166c70c68d9f8c853c1abca640b8660db2921
  # # forwarding error packet
  # shared_secret = 53eb63ea8a3fec3b3cd433b85cd62a4b145e1dda09391b348c4e1cd36a03ea66
  # ammag_key = 3761ba4d3e726d8abb16cba5950ee976b84937b61b7ad09e741724d7dee12eb5
  # stream = 3699fd352a948a05f604763c0bca2968d5eaca2b0118602e52e59121f050936c8dd90c24df7dc8cf8f1665e39a6c75e9e2c0900ea245c9ed3b0008148e0ae18bbfaea0c711d67eade980c6f5452e91a06b070bbde68b5494a92575c114660fb53cf04bf686e67ffa4a0f5ae41a59a39a8515cb686db553d25e71e7a97cc2febcac55df2711b6209c502b2f8827b13d3ad2f491c45a0cafe7b4d8d8810e805dee25d676ce92e0619b9c206f922132d806138713a8f69589c18c3fdc5acee41c1234b17ecab96b8c56a46787bba2c062468a13919afc18513835b472a79b2c35f9a91f38eb3b9e998b1000cc4a0dbd62ac1a5cc8102e373526d7e8f3c3a1b4bfb2f8a3947fe350cb89f73aa1bb054edfa9895c0fc971c2b5056dc8665902b51fced6dff80c
  # error packet for node 0: 9c5add3963fc7f6ed7f148623c84134b5647e1306419dbe2174e523fa9e2fbed3a06a19f899145610741c83ad40b7712aefaddec8c6baf7325d92ea4ca4d1df8bce517f7e54554608bf2bd8071a4f52a7a2f7ffbb1413edad81eeea5785aa9d990f2865dc23b4bc3c301a94eec4eabebca66be5cf638f693ec256aec514620cc28ee4a94bd9565bc4d4962b9d3641d4278fb319ed2b84de5b665f307a2db0f7fbb757366067d88c50f7e829138fde4f78d39b5b5802f1b92a8a820865af5cc79f9f30bc3f461c66af95d13e5e1f0381c184572a91dee1c849048a647a1158cf884064deddbf1b0b88dfe2f791428d0ba0f6fb2f04e14081f69165ae66d9297c118f0907705c9c4954a199bae0bb96fad763d690e7daa6cfda59ba7f2c8d11448b604d12d
  describe '.make_error_packet' do
    # node 4 is returning an error(temporary_node_failure)
    let(:failure_message) { Lightning::Onion::FailureMessages::TemporaryNodeFailure[0x2002] }

    let(:shared_secrets) do
      [
        '53eb63ea8a3fec3b3cd433b85cd62a4b145e1dda09391b348c4e1cd36a03ea66',
        'a6519e98832a0b179f62123b3567c106db99ee37bef036e783263602f3488fae',
        '3a6b412548762f0dbccce5c7ae7bb8147d1caf9b5471c34120b30bc9c04891cc',
        '21e13c2d7cfe7e18836df50872466117a295783ab8aab0e7ecc8c725503ad02d',
        'b5756b9b542727dbafc6765a49488b023a725d631af688fc031217e90770c328'
      ]
    end

    let(:expected4) do
      'a5e6bd0c74cb347f10cce367f949098f2457d14c046fd8a22cb96efb30b0fdcd' \
      'a8cb9168b50f2fd45edd73c1b0c8b33002df376801ff58aaa94000bf8a86f926' \
      '20f343baef38a580102395ae3abf9128d1047a0736ff9b83d456740ebbb4aeb3' \
      'aa9737f18fb4afb4aa074fb26c4d702f42968888550a3bded8c05247e045b866' \
      'baef0499f079fdaeef6538f31d44deafffdfd3afa2fb4ca9082b8f1c465371a9' \
      '894dd8c243fb4847e004f5256b3e90e2edde4c9fb3082ddfe4d1e734cacd96ef' \
      '0706bf63c9984e22dc98851bcccd1c3494351feb458c9c6af41c0044bea3c475' \
      '52b1d992ae542b17a2d0bba1a096c78d169034ecb55b6e3a7263c26017f03303' \
      '1228833c1daefc0dedb8cf7c3e37c9c37ebfe42f3225c326e8bcfd338804c145' \
      'b16e34e4'
    end

    let(:expected3) do
      'c49a1ce81680f78f5f2000cda36268de34a3f0a0662f55b4e837c83a8773c22aa081bab1616a0011585323930fa5b9fae0c85770a2279ff59ec427ad1bbff9001c0cd1497004bd2a0f68b50704cf6d6a4bf3c8b6a0833399a24b3456961ba00736785112594f65b6b2d44d9f5ea4e49b5e1ec2af978cbe31c67114440ac51a62081df0ed46d4a3df295da0b0fe25c0115019f03f15ec86fabb4c852f83449e812f141a9395b3f70b766ebbd4ec2fae2b6955bd8f32684c15abfe8fd3a6261e52650e8807a92158d9f1463261a925e4bfba44bd20b166d532f0017185c3a6ac7957adefe45559e3072c8dc35abeba835a8cb01a71a15c736911126f27d46a36168ca5ef7dccd4e2886212602b181463e0dd30185c96348f9743a02aca8ec27c0b90dca270'
    end
    let(:expected2) do
      'a5d3e8634cfe78b2307d87c6d90be6fe7855b4f2cc9b1dfb19e92e4b79103f61ff9ac25f412ddfb7466e74f81b3e545563cdd8f5524dae873de61d7bdfccd496af2584930d2b566b4f8d3881f8c043df92224f38cf094cfc09d92655989531524593ec6d6caec1863bdfaa79229b5020acc034cd6deeea1021c50586947b9b8e6faa83b81fbfa6133c0af5d6b07c017f7158fa94f0d206baf12dda6b68f785b773b360fd0497e16cc402d779c8d48d0fa6315536ef0660f3f4e1865f5b38ea49c7da4fd959de4e83ff3ab686f059a45c65ba2af4a6a79166aa0f496bf04d06987b6d2ea205bdb0d347718b9aeff5b61dfff344993a275b79717cd815b6ad4c0beb568c4ac9c36ff1c315ec1119a1993c4b61e6eaa0375e0aaf738ac691abd3263bf937e3'
    end
    let(:expected1) do
      'aac3200c4968f56b21f53e5e374e3a2383ad2b1b6501bbcc45abc31e59b26881b7dfadbb56ec8dae8857add94e6702fb4c3a4de22e2e669e1ed926b04447fc73034bb730f4932acd62727b75348a648a1128744657ca6a4e713b9b646c3ca66cac02cdab44dd3439890ef3aaf61708714f7375349b8da541b2548d452d84de7084bb95b3ac2345201d624d31f4d52078aa0fa05a88b4e20202bd2b86ac5b52919ea305a8949de95e935eed0319cf3cf19ebea61d76ba92532497fcdc9411d06bcd4275094d0a4a3c5d3a945e43305a5a9256e333e1f64dbca5fcd4e03a39b9012d197506e06f29339dfee3331995b21615337ae060233d39befea925cc262873e0530408e6990f1cbd233a150ef7b004ff6166c70c68d9f8c853c1abca640b8660db2921'
    end
    let(:expected0) do
      '9c5add3963fc7f6ed7f148623c84134b5647e1306419dbe2174e523fa9e2fbed3a06a19f899145610741c83ad40b7712aefaddec8c6baf7325d92ea4ca4d1df8bce517f7e54554608bf2bd8071a4f52a7a2f7ffbb1413edad81eeea5785aa9d990f2865dc23b4bc3c301a94eec4eabebca66be5cf638f693ec256aec514620cc28ee4a94bd9565bc4d4962b9d3641d4278fb319ed2b84de5b665f307a2db0f7fbb757366067d88c50f7e829138fde4f78d39b5b5802f1b92a8a820865af5cc79f9f30bc3f461c66af95d13e5e1f0381c184572a91dee1c849048a647a1158cf884064deddbf1b0b88dfe2f791428d0ba0f6fb2f04e14081f69165ae66d9297c118f0907705c9c4954a199bae0bb96fad763d690e7daa6cfda59ba7f2c8d11448b604d12d'
    end

    let(:error4) { Lightning::Onion::Sphinx.make_error_packet(shared_secrets[4], failure_message) }
    let(:error3) { Lightning::Onion::Sphinx.forward_error_packet(error4, shared_secrets[3]) }
    let(:error2) { Lightning::Onion::Sphinx.forward_error_packet(error3, shared_secrets[2]) }
    let(:error1) { Lightning::Onion::Sphinx.forward_error_packet(error2, shared_secrets[1]) }
    let(:error0) { Lightning::Onion::Sphinx.forward_error_packet(error1, shared_secrets[0]) }
    it { expect(error4.bth).to eq expected4 }
    it { expect(error3.bth).to eq expected3 }
    it { expect(error2.bth).to eq expected2 }
    it { expect(error1.bth).to eq expected1 }
    it { expect(error0.bth).to eq expected0 }
  end
end
